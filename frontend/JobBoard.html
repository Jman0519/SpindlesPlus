<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spindles Plus Internal Job Board</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <table id="data-table">
        <thead>
            <tr>
                <th>Customer Name</th>
                <th>Received Date</th>
                <th>Container</th>
                <th>Unit</th>
                <th>Tear Down</th>
                <th>Quoted Date</th>
                <th>Approval Date</th>
                <th>Cleaning</th>
                <th>Grind Required</th>
                <th>Grind Type</th>
                <th>Grind Info</th>
                <th>Grind Complete</th>
                <th>Motor Requirement</th>
                <th>Motor Info</th>
                <th>Parts Required</th>
                <th>Parts List</th>
                <th>Build</th>
                <th>Test</th>
                <th>Estimated Ship Date</th>
                <th>Ready To Ship</th>
            </tr>
        </thead>
        <tbody>
            <tr></tr>
        </tbody>
    </table>

    <script>
        function createTable(jobs) {
            let table = document.getElementById('data-table');
            let headers = ["Customer Name", "Received Date", "Container", "Unit", "Tear Down", "Quoted Date", "Approval Date", "Cleaning", "Grind Required", "Grind Type", "Grind Info", "Grind Complete", "Motor Requirement", "Motor Info", "Parts Required", "Parts List", "Build", "Test", "Estimated Ship Date", "Ready To Ship"];
            //create rows
            let rows = [];
            for (let i = 0; i < jobs.length; i++) {
                let row = document.createElement('tr');
                for (let header of headers) {
                    let cell = document.createElement('td');

                    let text = jobs[i][header];

                    if (header == "Received Date" || header == "Quoted Date" || header == "Approval Date" || header == "Estimated Ship Date") {
                        //change from yyyy-mm-dd to mm/dd/yy
                        text = text.split('-');
                        text = text[1] + '/' + text[2] + '/' + text[0].slice(-2);
                    }

                    if (jobs[i][header] === undefined || jobs[i][header] === "") {
                        text = "";
                    }

                    // cell.textContent = text;
                    let textRows = text.split('\n');
                    for (let textRow of textRows) {
                        cell.innerHTML += textRow;
                        cell.innerHTML += '<br>';
                    }
                    cell.innerHTML = cell.innerHTML.slice(0, -4);
                    row.appendChild(cell);
                }
                row.onclick = function () {
                    window.localStorage.setItem('job', JSON.stringify(jobs[i]));
                    window.location.href = '/EditJob.html';
                };
                rows.push(row);
            }

            //create headers
            let headerRow = document.createElement('tr');
            for (let headerName of headers) {
                let header = document.createElement('th');
                header.textContent = headerName;
                headerRow.appendChild(header);
            }

            // set the table
            table.innerHTML = '';
            table.appendChild(headerRow);
            for (let i = 0; i < rows.length; i++) {
                table.appendChild(rows[i]);
            }

            let createNewJobRow = document.createElement('tr');
            let createNewJobCell = document.createElement('td');
            createNewJobCell.colSpan = headers.length;
            createNewJobCell.innerHTML = '<button id="createNewJob">+ Create New Job</button>';
            createNewJobRow.appendChild(createNewJobCell);
            table.appendChild(createNewJobRow);

            let createNewJobButton = document.getElementById('createNewJob');
            createNewJobButton.onclick = function () {
                window.location.href = '/CreateNewJob.html';
            };
            createNewJobButton.style.fontSize = '20px';
        }

        async function getData() {
            let jobs = Object.values(await (await fetch("/getJobs")).json());
            window.localStorage.setItem('jobs', JSON.stringify(jobs));

            // TODO: check if the data is any different
            createTable(jobs);
            let updateJobs = fetch("/updateJobs").then(getData);
        }

        getData();
        // setInterval(function () {
        //     // Call a function repetatively with 2 Second interval
        //     getData();
        // }, 10000); //1000mSeconds update rate
    </script>
    <footer>
        <p>&copy; 2023 Spindles Plus Incorporated | All Rights Reserved |
            <a href="JobBoard.html">Job Board</a> |
            <a href="About.html">About</a> |
            <a href="CreateNewJob.html">Create New Job</a> |
        </p>
    </footer>
</body>

</html>